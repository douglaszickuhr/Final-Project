---
title: "Clustering companies by consumer complaints"
author: "Douglas Zickuhr"
date: "21/06/2018"
output:
  pdf_document: default
  html_document: default
---

# Loading libraries
```{r libraries}
library(tidyverse)
library(cluster)
library(ggbiplot)
library(fpc)
```

## Loading the dataset
```{r reading}
df <- read_csv('data/dataset.csv')
```

## Checking the dataframe (tibble)
```{r check data}
head(df)
glimpse(df)
```

## Aggregating the dataset to create indicators by company.
It's important to mention that just companies with more the 50 complaints and at least 5 solved complaints were considered.
```{r df_aggregation}
set.seed(123)
companies <- df %>%
  dplyr::filter(!is.na(company_name)) %>%
  dplyr::mutate(company_name = str_replace_all(company_name,"'","")) %>%
  dplyr::mutate(company_name = str_replace_all(company_name,'"',"")) %>%
  dplyr::mutate(company_name = str_trim(company_name)) %>%
  dplyr::mutate(average_weeks = difftime(complaint_closed_date,
                                  complaint_entered_date,
                                  units="weeks")) %>%
  dplyr::group_by(company_name) %>%
  dplyr::summarise(total_complaint = n(),
            total_solved_complaint = sum(complaint_attended == "Y"),
            perc_solved = total_solved_complaint/total_complaint,
            total_issues_types = n_distinct(complaint_issue_type),
            average_weeks = as.numeric(round(mean(average_weeks),digits = 2)),
            total_states = n_distinct(consumer_state)
            ) %>%
  dplyr::filter(total_complaint > 50) %>%
  dplyr::filter(total_solved_complaint > 5) %>%
  #dplyr::sample_n(200) %>% 
  dplyr::mutate(company_id = row_number())
```

## Scalling companies's indicators
```{r scalling}
companies_scalled <- companies %>%
  dplyr::select(-c("company_name","company_id")) %>%
  scale(center = TRUE,
        scale = TRUE)

```

## PCA - Principal component analysis - Reduction of dimensions
```{r pca}
companies_pca <- prcomp(companies_scalled, 
                        scale. = TRUE)
```


## Looking to the summary of the PCA it's possible to see that with PC3 it's possible to explain more than 82% of data variance
```{r pca_summary}
summary(companies_pca)
```

## Let's have a look at the biplot
```{r pca_biplot}
ggbiplot(companies_pca)
```

# Clustering

## Binding the companies data frame and principal components 
```{r companies_pca_binding}
companies <- cbind(companies,
                   companies_pca$x)
```


## K-means 
### Running silhouette analysis to find the best number of clustering
```{r kmeans_silhoette_analysis}
companies_silhouette_vector <- numeric(9)
k_var <- 2:10
nstart = 20

for (k in k_var){
  companies_kmeans <- kmeans(companies %>%
                  select(starts_with("PC")),
                centers = k,
                nstart = nstart)
  companies_kmeans_distance <- companies %>%
    select(starts_with("PC")) %>%
    dist()
  
  s <- silhouette(companies_kmeans$cluster,companies_kmeans_distance)
  companies_silhouette_vector[k-1] <- mean(s[,3])
}


silhouette_analysis <- tibble(
  clusters = k_var,
  s = companies_silhouette_vector
) %>%
  arrange(desc(s))

silhouette_analysis
```

### Running Kmeans with the best result from silhouette analysis
```{r kmeans}
k = as.numeric(silhouette_analysis[1,1])
companies_kmeans <- kmeans(companies %>%
                  select(starts_with("PC")),
                centers = k,
                nstart = nstart)
```


### Running kmetoid algorithm
```{r kmetoids}
k_var <- 2:10
pamk_analysis <- pamk(companies %>%
                  select(starts_with("PC")),
     krange = k_var <- 2:10,
     criterion = "asw",
     usepam = TRUE)

companies_kmetoids <- pam(companies %>%
                  select(starts_with("PC")),
    k = pamk_analysis$nc)


```

### Hierarchical Clustering
```{r hclust}
companies_distance <- dist(companies %>%
                             select(starts_with("PC")))

companies_hclust <- hclust(companies_distance,
                           method = "complete")
plot(companies_hclust)
```

```{r}
companies_hclust_cluster <- cutree(companies_hclust, k = 2)
table(companies_hclust_cluster, company_kmeans$cluster)

```


