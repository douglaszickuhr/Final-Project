---
title: "Clustering companies by consumer complaints"
author: "Douglas Zickuhr"
date: "21/06/2018"
output:
  html_document: default
  pdf_document: default
---

# Loading libraries
```{r libraries}
library(tidyverse)
library(cluster)
library(ggbiplot)
library(fpc)
```

## Loading the dataset
```{r reading}
df <- read_csv('data/dataset.csv')
```

## Checking the dataframe
```{r check data}
head(df)
glimpse(df)
```

## Aggregating the dataset to create indicators by company.
It's important to mention that just companies with more the 50 complaints and at least 5 solved complaints were considered.
```{r df_aggregation}
set.seed(123)
companies <- df %>%
  dplyr::filter(!is.na(company_name)) %>%
  dplyr::mutate(company_name = str_replace_all(company_name,"'","")) %>%
  dplyr::mutate(company_name = str_replace_all(company_name,'"',"")) %>%
  dplyr::mutate(company_name = str_trim(company_name)) %>%
  dplyr::mutate(average_weeks = difftime(complaint_closed_date,
                                  complaint_entered_date,
                                  units="weeks")) %>%
  dplyr::group_by(company_name) %>%
  dplyr::summarise(total_complaint = n(),
            total_solved_complaint = sum(complaint_attended == "Y"),
            perc_solved = total_solved_complaint/total_complaint,
            average_weeks = as.numeric(round(mean(average_weeks),digits = 2))
            ) %>%
  dplyr::filter(total_complaint > 50) %>%
  dplyr::filter(total_solved_complaint > 5) %>%
  dplyr::select(-c("total_solved_complaint")) %>%
  dplyr::mutate(company_id = row_number())
```

## Scalling companies's indicators
```{r scalling}
companies_scalled <- companies %>%
  dplyr::select(-c("company_name","company_id")) %>%
  scale(center = TRUE,
        scale = TRUE)

```

## PCA - Principal component analysis
PCA is a algorithm to apply reduction of dimensions
```{r pca}
companies_pca <- prcomp(companies_scalled, 
                        scale. = FALSE)
```

Looking to the summary of the PCA it's possible to see that with PC3 it's possible to explain more than 82% of data variance
```{r pca_summary}
summary(companies_pca)
```

## Having a look at the biplot
```{r pca_biplot}
ggbiplot(companies_pca)
```

# Clustering

## Binding the companies data frame and principal components 
```{r companies_pca_binding}
companies_with_pca <- cbind(companies,
                   companies_pca$x)
```


## K-means 
### Running silhouette analysis to find the best number of clustering
```{r kmeans_silhoette_analysis}
companies_silhouette_vector <- numeric(9)
k_var <- 2:10
nstart = 20

for (k in k_var){
  companies_kmeans <- kmeans(companies_with_pca %>%
                               select(starts_with("PC")),
                             centers = k,
                             nstart = nstart)
  
  
  companies_kmeans_distance <- companies_with_pca %>%
    select(starts_with("PC")) %>%
    dist()
  
  s <- silhouette(companies_kmeans$cluster,companies_kmeans_distance)
  
  companies_silhouette_vector[k-1] <- mean(s[,3])
}


silhouette_analysis <- tibble(
  clusters = k_var,
  s = companies_silhouette_vector
) %>%
  arrange(desc(s))

silhouette_analysis
```

### Running Kmeans with the best result from silhouette analysis
```{r kmeans}
#k = as.numeric(silhouette_analysis[1,1])
k = 5
companies_kmeans <- kmeans(companies_with_pca %>%
                  select(starts_with("PC")),
                centers = k,
                nstart = nstart)
```


### Hierarchical Clustering
Clustering observations based on the distance of the Principal Components
Generating Dendogram
```{r hclust}
companies_distance <- dist(companies_with_pca %>%
                             select(starts_with("PC")))

companies_hclust <- hclust(companies_distance,
                           method = "complete")
plot(companies_hclust)
```


### Silhouette analysis
Comparing the Silhouette for different methods and clusters
```{r hclust_silhouette}
set.seed(123)
met <- c("complete","single","average")
hclust_sil <- matrix(NA, ncol = 3, nrow = 9,
                     dimnames = list(2:10, met))

for (i in 2:10){
  for (j in seq_along(met)){
    hc <- hclust(companies_distance, met[j])
    ct <- cutree(hc,i)
    sil <- silhouette(ct,companies_distance)
    hclust_sil[i-1,j] <- mean(sil[,3])
  }
}

print(hclust_sil)
```

Generating hierarchical cluster for 5 different clusters
```{r hclust_2}
set.seed(123)
companies_hclust <- hclust(companies_distance,
                           method = "complete")

companies_hclust_cluster <- cutree(companies_hclust,
                                   k = 5)


companies_pca_cluster <- cbind(companies_with_pca,companies_hclust_cluster) %>%
  dplyr::rename(hclust = companies_hclust_cluster)
```





## Evaluation of values by clusters (Kmeans and Hierarchical Clusters)
### Binding the clusters into a single dataframe
```{r binding clusters to dataframe}
companies_clusters <- companies_with_pca %>%
  cbind(kmeans_cluster = companies_kmeans$cluster) %>%
  cbind(hclust_cluster = companies_hclust_cluster)
```

### Plotting the data based on Kmeans clusters
```{r kmeans scatter plot}
ggplot(companies_with_pca) + 
  geom_point(aes(PC1,
                 PC2,
                 colour=factor(companies_kmeans$cluster)))
```

### Average values by Kmeans Clusters
```{r average values for kmeans}
companies_clusters %>%
  dplyr::select(-c("hclust_cluster")) %>%
  dplyr::group_by(kmeans_cluster) %>%
  dplyr::summarise(total_complaint = mean(total_complaint),
                   perc_solved = mean(perc_solved),
                   average_weeks = mean(average_weeks),
                   n = n()) %>%
  dplyr::select(-starts_with("PC"),
                -starts_with("company"))
```

### Plotting the data based on hierarchical clusters
```{r}
ggplot(companies_pca_cluster) + 
  geom_point(aes(PC1,PC2,colour=factor(hclust)))
```

### Average values by Hierarchical Clusters
```{r average values for hclust}
companies_clusters %>%
  dplyr::select(-c("kmeans_cluster")) %>%
  dplyr::group_by(hclust_cluster) %>%
  dplyr::summarise(total_complaint = mean(total_complaint),
                   perc_solved = mean(perc_solved),
                   average_weeks = mean(average_weeks),
                   n = n()) %>%
  dplyr::select(-starts_with("PC"),
                -starts_with("company"))
```

